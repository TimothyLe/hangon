<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hangon: The Complete Productivity Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 500px;
            width: 100%;
        }
        
        .wide-container {
            max-width: 800px;
        }
        
        h1 {
            color: white;
            margin-bottom: 36px;
            text-align: center;
            font-weight: 900;
            font-size: 1.5rem;
        }
        h2 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 300;
            font-size: 1.5rem;
        }
        
        /* Todo List Styles */
        .add-task {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .add-task input {
            flex: 1;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 12px 15px;
            color: white;
            font-size: 1rem;
            outline: none;
        }
        
        .add-task input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .add-task button {
            background: rgba(46, 204, 113, 0.7);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .add-task button:hover {
            background: rgba(46, 204, 113, 0.9);
            transform: translateY(-2px);
        }
        
        .todo-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .todo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.2s ease;
        }
        
        .todo-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .todo-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .todo-text {
            flex: 1;
            color: white;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .todo-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .remove-btn {
            background: rgba(231, 76, 60, 0.7);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }
        
        .remove-btn:hover {
            background: rgba(231, 76, 60, 0.9);
        }
        
        .task-count {
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .empty-state {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 20px;
            font-style: italic;
        }
        
        /* Calculator Styles */
        .calculator {
            max-width: 400px;
        }
        
        .display {
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            font-size: 1.5rem;
            font-weight: 300;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 15px;
            text-align: right;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            word-break: break-all;
            overflow-wrap: break-word;
        }
        
        .base-converter {
            margin-bottom: 20px;
        }
        
        .base-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .base-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .base-input label {
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .base-input input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px;
            color: white;
            font-size: 0.9rem;
            outline: none;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 45px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .operator {
            background: rgba(255, 165, 0, 0.7);
        }
        
        .equals {
            background: rgba(46, 204, 113, 0.7);
        }
        
        .function {
            background: rgba(52, 152, 219, 0.7);
            font-size: 0.7rem;
        }
        
        .clear {
            background: rgba(231, 76, 60, 0.7);
        }
        
        /* Drawing Pad Styles */
        .drawing-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            align-items: center;
        }
        
        .drawing-controls button {
            min-height: 40px;
            padding: 8px 12px;
            font-size: 0.8rem;
        }
        
        .drawing-controls button.active {
            background: rgba(46, 204, 113, 0.8);
        }
        
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            background-color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .color-preview:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .color-slider {
            width: 150px;
            height: 20px;
            background: linear-gradient(to right, 
                #ff0000 0%, #ffff00 17%, #00ff00 33%, 
                #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .color-slider-thumb {
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: -1px;
            left: 0px;
            cursor: grab;
            border: 2px solid #333;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: box-shadow 0.2s ease;
        }
        
        .color-slider-thumb:active {
            cursor: grabbing;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
            margin: 0 auto;
        }
        
        #drawingCanvas, #previewCanvas {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            cursor: crosshair;
            display: block;
        }
        
        #previewCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Diary Styles */
        .diary-container {
            max-width: 800px;
        }
        
        .diary-textarea {
            width: 100%;
            min-height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-size: 1rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        .diary-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .diary-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .char-count {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <h1>🙃 hangon 🙂</h1>
    <br>
    <br>
    <div class="container todo-section">
        <h2>📝 Todo List</h2>
        
        <div class="add-task">
            <input type="text" id="taskInput" placeholder="Add a new task..." maxlength="100">
            <button onclick="addTask()">Add</button>
        </div>
        
        <div class="task-count" id="taskCount">0 tasks</div>
        
        <div class="todo-list" id="todoList">
            <div class="empty-state">No tasks yet. Add one above!</div>
        </div>
    </div>

    <div class="container calculator">
        <h2>🧮 Scientific Calculator</h2>
        
        <div class="base-converter">
            <div class="base-inputs">
                <div class="base-input">
                    <label>Decimal (DEC)</label>
                    <input type="text" id="decInput" style="width:90%" placeholder="Enter decimal" oninput="convertFromBase('dec')">
                </div>
                <div class="base-input">
                    <label>Hexadecimal (HEX)</label>
                    <input type="text" id="hexInput" style="width:90%" placeholder="Enter hex" oninput="convertFromBase('hex')">
                </div>
                <div class="base-input">
                    <label>Binary (BIN)</label>
                    <input type="text" id="binInput" style="width:90%" placeholder="Enter binary" oninput="convertFromBase('bin')">
                </div>
                <div class="base-input">
                    <label>Octal (OCT)</label>
                    <input type="text" id="octInput" style="width:90%" placeholder="Enter octal" oninput="convertFromBase('oct')">
                </div>
            </div>
        </div>
        
        <div class="display" id="display">0</div>
        <div class="buttons">
            <button class="clear" onclick="clearAll()">C</button>
            <button class="clear" onclick="clearEntry()">CE</button>
            <button onclick="deleteLast()">⌫</button>
            <button class="function" onclick="appendFunction('sin(')">sin</button>
            <button class="function" onclick="appendFunction('cos(')">cos</button>
            
            <button class="function" onclick="appendFunction('tan(')">tan</button>
            <button class="function" onclick="appendFunction('log(')">log</button>
            <button class="function" onclick="appendFunction('ln(')">ln</button>
            <button class="function" onclick="appendFunction('sqrt(')">√</button>
            <button class="function" onclick="appendToDisplay('^')">x^y</button>
            
            <button onclick="appendToDisplay('(')">(</button>
            <button onclick="appendToDisplay(')')">)</button>
            <button onclick="appendToDisplay('7')">7</button>
            <button onclick="appendToDisplay('8')">8</button>
            <button onclick="appendToDisplay('9')">9</button>
            
            <button class="operator" onclick="appendToDisplay('/')">/</button>
            <button onclick="appendToDisplay('4')">4</button>
            <button onclick="appendToDisplay('5')">5</button>
            <button onclick="appendToDisplay('6')">6</button>
            <button class="operator" onclick="appendToDisplay('*')">×</button>
            
            <button class="operator" onclick="appendToDisplay('-')">-</button>
            <button onclick="appendToDisplay('1')">1</button>
            <button onclick="appendToDisplay('2')">2</button>
            <button onclick="appendToDisplay('3')">3</button>
            <button class="operator" onclick="appendToDisplay('+')">+</button>
            
            <button onclick="appendToDisplay('π')">π</button>
            <button onclick="appendToDisplay('e')">e</button>
            <button onclick="appendToDisplay('0')">0</button>
            <button onclick="appendToDisplay('.')">.</button>
            <button class="equals" onclick="calculate()">=</button>
        </div>
    </div>

    <div class="container wide-container">
        <h2>🎨 Drawing Pad</h2>
        
        <div class="drawing-controls">
            <button id="rectTool" class="active" onclick="setTool('rectangle')">Rectangle</button>
            <button id="circleTool" onclick="setTool('circle')">Circle</button>
            <button id="diamondTool" onclick="setTool('diamond')">Diamond</button>
            <button id="arrowTool" onclick="setTool('arrow')">Arrow</button>
            <button id="freeTool" onclick="setTool('free')">Free Draw</button>
            <button onclick="clearCanvas()">Clear</button>
            
            <div class="color-picker-container">
                <div class="color-preview" id="colorPreview" onclick="toggleColorSlider()"></div>
                <div class="color-slider" id="colorSlider" onclick="selectColor(event)">
                    <div class="color-slider-thumb" id="colorThumb"></div>
                </div>
            </div>
        </div>
        
        <div class="canvas-container" style="width:150%">
            <canvas id="drawingCanvas" width="750" height="400"></canvas>
            <canvas id="previewCanvas" width="750" height="400"></canvas>
        </div>
    </div>

    <div class="container diary-container">
        <h2>📖 Personal Diary</h2>
        
        <textarea 
            id="diaryText" 
            class="diary-textarea" 
            placeholder="Write your thoughts here... Supports English, 中文, العربية, and all UTF-8 characters.

你可以写中文...
يمكنك الكتابة بالعربية...
Vous pouvez écrire en français...
Можете писать по-русски...

记录你的想法、计划和感受..."
            oninput="updateDiary()"
        ></textarea>
        
        <div class="diary-info">
            <span>Auto-saved</span>
            <span class="char-count" id="charCount">0 / 50,000 characters</span>
        </div>
    </div>

    <script>
        // Todo List Functionality
        let tasks = [];
        let taskIdCounter = 1;

        // Load tasks from localStorage on page load
        function loadTasks() {
            try {
                const savedTasks = localStorage.getItem('todoTasks');
                const savedCounter = localStorage.getItem('taskIdCounter');
                
                if (savedTasks) {
                    tasks = JSON.parse(savedTasks);
                    console.log('Loaded tasks from localStorage:', tasks.length, 'tasks');
                }
                
                if (savedCounter) {
                    taskIdCounter = parseInt(savedCounter);
                }
            } catch (error) {
                console.error('Error loading tasks from localStorage:', error);
                tasks = [];
                taskIdCounter = 1;
            }
        }

        // Save tasks to localStorage
        function saveTasks() {
            try {
                localStorage.setItem('todoTasks', JSON.stringify(tasks));
                localStorage.setItem('taskIdCounter', taskIdCounter.toString());
                console.log('Tasks saved to localStorage');
            } catch (error) {
                console.error('Error saving tasks to localStorage:', error);
            }
        }

        function updateTaskCount() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.completed).length;
            document.getElementById('taskCount').textContent = 
                `${totalTasks} task${totalTasks !== 1 ? 's' : ''} (${completedTasks} completed)`;
        }

        function renderTasks() {
            const todoList = document.getElementById('todoList');
            
            if (tasks.length === 0) {
                todoList.innerHTML = '<div class="empty-state">No tasks yet. Add one above!</div>';
                updateTaskCount();
                return;
            }

            todoList.innerHTML = tasks.map(task => `
                <div class="todo-item">
                    <input type="checkbox" 
                           ${task.completed ? 'checked' : ''} 
                           onchange="toggleTask(${task.id})">
                    <span class="todo-text ${task.completed ? 'completed' : ''}">${task.text}</span>
                    <button class="remove-btn" onclick="removeTask(${task.id})">Remove</button>
                </div>
            `).join('');
            
            updateTaskCount();
        }

        function addTask() {
            const taskInput = document.getElementById('taskInput');
            const taskText = taskInput.value.trim();
            
            if (taskText === '') {
                taskInput.focus();
                return;
            }
            
            tasks.push({
                id: taskIdCounter++,
                text: taskText,
                completed: false,
                createdAt: new Date().toISOString()
            });
            
            taskInput.value = '';
            saveTasks();
            renderTasks();
        }

        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                task.completedAt = task.completed ? new Date().toISOString() : null;
                saveTasks();
                renderTasks();
            }
        }

        function removeTask(taskId) {
            tasks = tasks.filter(t => t.id !== taskId);
            saveTasks();
            renderTasks();
        }

        // Enter key support for adding tasks
        document.getElementById('taskInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        // Calculator Functionality
        let display = document.getElementById('display');
        let currentInput = '0';
        let shouldResetDisplay = false;

        // Base Conversion Functions
        let conversionInProgress = false;

        function convertFromBase(sourceBase) {
            if (conversionInProgress) return;
            conversionInProgress = true;

            const inputs = {
                dec: document.getElementById('decInput'),
                hex: document.getElementById('hexInput'),
                bin: document.getElementById('binInput'),
                oct: document.getElementById('octInput')
            };

            const sourceValue = inputs[sourceBase].value.trim();
            if (!sourceValue) {
                // Clear other inputs if source is empty
                Object.keys(inputs).forEach(base => {
                    if (base !== sourceBase) {
                        inputs[base].value = '';
                    }
                });
                conversionInProgress = false;
                return;
            }

            try {
                let decimalValue;
                
                // Convert source to decimal
                switch (sourceBase) {
                    case 'dec':
                        decimalValue = parseInt(sourceValue, 10);
                        break;
                    case 'hex':
                        decimalValue = parseInt(sourceValue.replace(/[^0-9a-fA-F]/g, ''), 16);
                        break;
                    case 'bin':
                        decimalValue = parseInt(sourceValue.replace(/[^01]/g, ''), 2);
                        break;
                    case 'oct':
                        decimalValue = parseInt(sourceValue.replace(/[^0-7]/g, ''), 8);
                        break;
                }

                if (isNaN(decimalValue) || decimalValue < 0) {
                    throw new Error('Invalid input');
                }

                // Convert to other bases
                if (sourceBase !== 'dec') inputs.dec.value = decimalValue.toString();
                if (sourceBase !== 'hex') inputs.hex.value = decimalValue.toString(16).toUpperCase();
                if (sourceBase !== 'bin') inputs.bin.value = decimalValue.toString(2);
                if (sourceBase !== 'oct') inputs.oct.value = decimalValue.toString(8);

            } catch (error) {
                console.error('Base conversion error:', error);
            }

            conversionInProgress = false;
        }

        function updateDisplay() {
            display.textContent = currentInput;
        }

        function appendToDisplay(value) {
            if (shouldResetDisplay) {
                currentInput = '';
                shouldResetDisplay = false;
            }
            
            if (currentInput === '0' && value !== '.') {
                currentInput = value;
            } else {
                currentInput += value;
            }
            updateDisplay();
        }

        function appendFunction(func) {
            if (shouldResetDisplay) {
                currentInput = '';
                shouldResetDisplay = false;
            }
            
            if (currentInput === '0') {
                currentInput = func;
            } else {
                currentInput += func;
            }
            updateDisplay();
        }

        function clearAll() {
            currentInput = '0';
            updateDisplay();
        }

        function clearEntry() {
            currentInput = '0';
            updateDisplay();
        }

        function deleteLast() {
            if (currentInput.length > 1) {
                currentInput = currentInput.slice(0, -1);
            } else {
                currentInput = '0';
            }
            updateDisplay();
        }

        function calculate() {
            try {
                let expression = currentInput
                    .replace(/π/g, Math.PI)
                    .replace(/e/g, Math.E)
                    .replace(/sin\(/g, 'Math.sin(')
                    .replace(/cos\(/g, 'Math.cos(')
                    .replace(/tan\(/g, 'Math.tan(')
                    .replace(/log\(/g, 'Math.log10(')
                    .replace(/ln\(/g, 'Math.log(')
                    .replace(/sqrt\(/g, 'Math.sqrt(')
                    .replace(/\^/g, '**');

                let result = eval(expression);
                
                if (isNaN(result)) {
                    throw new Error('Invalid calculation');
                }
                
                if (!isFinite(result)) {
                    throw new Error('Result is infinity');
                }

                if (result % 1 === 0) {
                    currentInput = result.toString();
                } else {
                    currentInput = parseFloat(result.toFixed(10)).toString();
                }
                
                shouldResetDisplay = true;
                updateDisplay();
            } catch (error) {
                currentInput = 'Error';
                shouldResetDisplay = true;
                updateDisplay();
            }
        }

        // Drawing Pad Functionality
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');
        
        let currentTool = 'rectangle';
        let isDrawing = false;
        let startX, startY;
        let currentColor = '#2c3e50';
        
        // Color picker variables
        let isDraggingSlider = false;
        
        // Initialize color picker
        function initColorPicker() {
            const colorPreview = document.getElementById('colorPreview');
            const colorThumb = document.getElementById('colorThumb');
            
            colorPreview.style.backgroundColor = currentColor;
            updateSliderPosition(0.2); // Start at a nice blue position
        }
        
        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }
        
        function updateSliderPosition(position) {
            const slider = document.getElementById('colorSlider');
            const thumb = document.getElementById('colorThumb');
            const sliderWidth = slider.offsetWidth;
            
            // Clamp position between 0 and 1
            position = Math.max(0, Math.min(1, position));
            
            // Update thumb position
            const thumbPosition = position * (sliderWidth - 22);
            thumb.style.left = `${thumbPosition}px`;
            
            // Calculate color based on position
            const hue = position * 360;
            currentColor = hslToHex(hue, 80, 50);
            
            // Update preview
            document.getElementById('colorPreview').style.backgroundColor = currentColor;
        }
        
        function selectColor(event) {
            const slider = document.getElementById('colorSlider');
            const rect = slider.getBoundingClientRect();
            const position = (event.clientX - rect.left) / rect.width;
            updateSliderPosition(position);
        }
        
        // Slider dragging functionality
        document.getElementById('colorThumb').addEventListener('mousedown', (e) => {
            isDraggingSlider = true;
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDraggingSlider) return;
            
            const slider = document.getElementById('colorSlider');
            const rect = slider.getBoundingClientRect();
            const position = (e.clientX - rect.left) / rect.width;
            updateSliderPosition(position);
        });
        
        document.addEventListener('mouseup', () => {
            isDraggingSlider = false;
        });

        function setTool(tool) {
            currentTool = tool;
            // Update active button
            document.querySelectorAll('.drawing-controls button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + 'Tool').classList.add('active');
            
            // Change cursor based on tool
            canvas.style.cursor = tool === 'free' ? 'brush' : 'crosshair';
            previewCanvas.style.cursor = tool === 'free' ? 'brush' : 'crosshair';
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        }
        
        function clearPreview() {
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        }
        
        function drawPreview(startX, startY, currentX, currentY) {
            clearPreview();
            
            previewCtx.strokeStyle = currentColor;
            previewCtx.lineWidth = 2;
            previewCtx.fillStyle = 'transparent';
            previewCtx.setLineDash([5, 5]); // Dashed line for preview
            
            switch (currentTool) {
                case 'rectangle':
                    previewCtx.strokeRect(startX, startY, currentX - startX, currentY - startY);
                    break;
                    
                case 'circle':
                    const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
                    previewCtx.beginPath();
                    previewCtx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    previewCtx.stroke();
                    break;
                    
                case 'diamond':
                    const centerX = (startX + currentX) / 2;
                    const centerY = (startY + currentY) / 2;
                    
                    previewCtx.beginPath();
                    previewCtx.moveTo(centerX, startY);
                    previewCtx.lineTo(currentX, centerY);
                    previewCtx.lineTo(centerX, currentY);
                    previewCtx.lineTo(startX, centerY);
                    previewCtx.closePath();
                    previewCtx.stroke();
                    break;
                    
                case 'arrow':
                    // Arrow shaft
                    previewCtx.beginPath();
                    previewCtx.moveTo(startX, startY);
                    previewCtx.lineTo(currentX, currentY);
                    previewCtx.stroke();
                    
                    // Arrow head
                    const angle = Math.atan2(currentY - startY, currentX - startX);
                    const headLength = 20;
                    
                    previewCtx.beginPath();
                    previewCtx.moveTo(currentX, currentY);
                    previewCtx.lineTo(
                        currentX - headLength * Math.cos(angle - Math.PI / 6),
                        currentY - headLength * Math.sin(angle - Math.PI / 6)
                    );
                    previewCtx.moveTo(currentX, currentY);
                    previewCtx.lineTo(
                        currentX - headLength * Math.cos(angle + Math.PI / 6),
                        currentY - headLength * Math.sin(angle + Math.PI / 6)
                    );
                    previewCtx.stroke();
                    break;
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            if (isDraggingSlider) return;
            
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            
            if (currentTool === 'free') {
                ctx.beginPath();
                ctx.moveTo(startX, startY);
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || isDraggingSlider) return;
            
            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            if (currentTool === 'free') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.setLineDash([]); // Solid line for free drawing
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
            } else {
                // Show preview for shape tools
                drawPreview(startX, startY, currentX, currentY);
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (!isDrawing || isDraggingSlider) return;
            isDrawing = false;
            
            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;
            
            // Clear preview and draw final shape
            clearPreview();
            
            if (currentTool !== 'free') {
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = 2;
                ctx.fillStyle = 'transparent';
                ctx.setLineDash([]); // Solid line for final drawing
                
                switch (currentTool) {
                    case 'rectangle':
                        ctx.strokeRect(startX, startY, endX - startX, endY - startY);
                        break;
                        
                    case 'circle':
                        const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                        ctx.beginPath();
                        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                        ctx.stroke();
                        break;
                        
                    case 'diamond':
                        const centerX = (startX + endX) / 2;
                        const centerY = (startY + endY) / 2;
                        
                        ctx.beginPath();
                        ctx.moveTo(centerX, startY);
                        ctx.lineTo(endX, centerY);
                        ctx.lineTo(centerX, endY);
                        ctx.lineTo(startX, centerY);
                        ctx.closePath();
                        ctx.stroke();
                        break;
                        
                    case 'arrow':
                        // Arrow shaft
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX, endY);
                        ctx.stroke();
                        
                        // Arrow head
                        const angle = Math.atan2(endY - startY, endX - startX);
                        const headLength = 20;
                        
                        ctx.beginPath();
                        ctx.moveTo(endX, endY);
                        ctx.lineTo(
                            endX - headLength * Math.cos(angle - Math.PI / 6),
                            endY - headLength * Math.sin(angle - Math.PI / 6)
                        );
                        ctx.moveTo(endX, endY);
                        ctx.lineTo(
                            endX - headLength * Math.cos(angle + Math.PI / 6),
                            endY - headLength * Math.sin(angle + Math.PI / 6)
                        );
                        ctx.stroke();
                        break;
                }
            }
        });
        
        // Prevent drawing when clicking outside canvas
        canvas.addEventListener('mouseleave', () => {
            if (isDrawing && currentTool !== 'free') {
                clearPreview();
            }
        });

        // Diary Functionality
        function loadDiary() {
            try {
                const savedDiary = localStorage.getItem('diaryContent');
                if (savedDiary) {
                    document.getElementById('diaryText').value = savedDiary;
                    updateCharCount();
                }
            } catch (error) {
                console.error('Error loading diary:', error);
            }
        }

        function updateDiary() {
            const diaryText = document.getElementById('diaryText').value;
            
            // Save to localStorage
            try {
                localStorage.setItem('diaryContent', diaryText);
            } catch (error) {
                console.error('Error saving diary:', error);
            }
            
            updateCharCount();
        }

        function updateCharCount() {
            const diaryText = document.getElementById('diaryText').value;
            const charCount = diaryText.length;
            const maxChars = 50000; // About 1000 lines of text
            
            document.getElementById('charCount').textContent = `${charCount.toLocaleString()} / ${maxChars.toLocaleString()} characters`;
            
            // Change color if approaching limit
            const countElement = document.getElementById('charCount');
            if (charCount > maxChars * 0.9) {
                countElement.style.color = '#e74c3c';
            } else if (charCount > maxChars * 0.7) {
                countElement.style.color = '#f39c12';
            } else {
                countElement.style.color = 'rgba(255, 255, 255, 0.7)';
            }
        }

        // Keyboard support for calculator
        document.addEventListener('keydown', function(event) {
            // Don't interfere with typing in inputs
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            const key = event.key;
            
            if (key >= '0' && key <= '9' || key === '.') {
                appendToDisplay(key);
            } else if (key === '+' || key === '-' || key === '*' || key === '/') {
                appendToDisplay(key);
            } else if (key === '(' || key === ')') {
                appendToDisplay(key);
            } else if (key === 'Enter' || key === '=') {
                event.preventDefault();
                calculate();
            } else if (key === 'Escape' || key === 'c' || key === 'C') {
                clearAll();
            } else if (key === 'Backspace') {
                deleteLast();
            }
        });

        // Initialize all components
        loadTasks();
        renderTasks();
        loadDiary();
    </script>
</body>
</html>
